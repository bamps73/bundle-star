#!/usr/bin/env ruby

require "rubygems"
require "octokit"

module Bundler
  class Star
    attr_reader :installer

    def initialize(installer)
      @installer = installer
    end

    def star
      if repo = repository
        begin
          client = Octokit::Client.new netrc: true
          client.star repo
          message = "\e[33m"
          message << (macos_higher_lion? ? "\xe2\xad\x90  " : "\xe2\x98\x85  ")
          puts message + "starred #{repo} (^_^)b\e[0m"
        rescue => e
          puts "\e[31mfailed starring #{repo}, reason #{e}\e[0m"
          puts e.backtrace if ENV['DEBUG']
        end
      end
    end

  private

    def repository
      url = installer.spec.homepage
      if url =~ /\Ahttps?:\/\/([^.]+)?\.?github.com\/(.+)/
        if $1 == nil
          $2
        elsif $1 == 'www'
          $2
        else
          "#{$1}/#{$2}"
        end
      end
    end

    def macos_higher_lion?
      unless RUBY_PLATFORM =~ /darwin/
        return false
      end
      macos_version = `/usr/bin/sw_vers -productVersion`.chomp.slice(/\d+\.\d+/).to_f
      macos_version >= 10.7
    end
  end
end

Gem.post_install do |installer|
  Bundler::Star.new(installer).star
end

load(Gem.bin_path("bundler", "bundle"))
